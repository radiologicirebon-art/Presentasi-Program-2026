<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Radiologi | Permohonan Re-Expertise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body class="bg-light">

<!-- LOGIN -->
<div id="login" class="container mt-5">
  <div class="card shadow col-md-6 mx-auto">
    <div class="card-body">
      <h4 class="text-center mb-3">Login Role</h4>
      <select id="role" class="form-select mb-3">
        <option value="">-- Pilih Role --</option>
        <option>Dokter Spesialis Radiologi</option>
        <option>Ranap (DPJP / Pengirim / Karu / TAF)</option>
      </select>
      <button class="btn btn-primary w-100" onclick="enterApp()">Masuk</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="container d-none mt-4">
  <h5>Role: <span id="roleLabel"></span></h5>

  <!-- FORM -->
  <div class="card mb-4">
    <div class="card-header">Form Permohonan Re-Expertise</div>
    <div class="card-body">
      <form id="formRe" onsubmit="return false;">
        <div class="row g-2">
          <div class="col-md-3"><input id="norm" class="form-control" placeholder="No RM"></div>
          <div class="col-md-3"><input id="pasien" class="form-control" placeholder="Nama Pasien"></div>
          <div class="col-md-3"><input id="tanggal" type="date" class="form-control"></div>
          <div class="col-md-3">
            <select id="modalitas" class="form-select">
              <option>X-Ray</option>
              <option>CT</option>
              <option>MRI</option>
              <option>USG</option>
            </select>
          </div>
          <div class="col-md-6"><input id="jenis" class="form-control" placeholder="Jenis Pemeriksaan"></div>
          <div class="col-md-6"><input id="alasan" class="form-control" placeholder="Alasan Re-Expertise"></div>
        </div>
        <button class="btn btn-success mt-3" onclick="submitForm()">Kirim Permohonan</button>
      </form>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="row mb-3">
    <div class="col"><div class="card text-center"><div class="card-body">üü° Belum<br><h3 id="cBelum">0</h3></div></div></div>
    <div class="col"><div class="card text-center"><div class="card-body">üü¢ Sudah<br><h3 id="cSudah">0</h3></div></div></div>
    <div class="col"><div class="card text-center"><div class="card-body">‚è±Ô∏è Rata-rata<br><h3 id="avgTime">0 menit</h3></div></div></div>
  </div>

  <!-- TABLE -->
  <table class="table table-bordered table-sm bg-white">
    <thead class="table-light">
      <tr>
        <th>No RM</th>
        <th>Pasien</th>
        <th>Modalitas</th>
        <th>Tanggal</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  databaseURL: "https://new-reexpertise2026-default-rtdb.asia-southeast1.firebasedatabase.app/"
});
var db = firebase.database();

/* ================= LOGIN ================= */
function enterApp() {
  var role = document.getElementById("role").value;
  if (!role) return alert("Pilih role");

  localStorage.setItem("role", role);
  document.getElementById("login").classList.add("d-none");
  document.getElementById("app").classList.remove("d-none");
  document.getElementById("roleLabel").innerText = role;

  loadRealtime();
}

/* ================= SUBMIT ================= */
function submitForm() {
  db.ref("permohonan").push({
    norm: norm.value,
    pasien: pasien.value,
    tanggal: tanggal.value,
    modalitas: modalitas.value,
    jenis: jenis.value,
    alasan: alasan.value,
    status: "Belum",
    jamMasuk: new Date().toISOString(),
    jamSelesai: ""
  });
  formRe.reset();
}

/* ================= UPDATE STATUS ================= */
function updateStatus(key) {
  if (localStorage.getItem("role") !== "Dokter Spesialis Radiologi")
    return alert("Akses ditolak");

  db.ref("permohonan/" + key).update({
    status: "Sudah",
    jamSelesai: new Date().toISOString()
  });

  window.open("https://wa.me/6285156868857?text=Hasil%20re-expertise%20radiologi%20telah%20selesai");
}

/* ================= REALTIME ================= */
function loadRealtime() {
  db.ref("permohonan").on("value", snap => {
    tbody.innerHTML = "";
    let b = 0, s = 0, total = 0, cnt = 0;

    snap.forEach(c => {
      let d = c.val();
      if (d.status === "Belum") b++;
      if (d.status === "Sudah" && d.jamSelesai) {
        s++;
        total += (new Date(d.jamSelesai) - new Date(d.jamMasuk)) / 60000;
        cnt++;
      }

      let can = localStorage.getItem("role") === "Dokter Spesialis Radiologi" && d.status !== "Sudah";

      tbody.innerHTML += `
        <tr>
          <td>${d.norm}</td>
          <td>${d.pasien}</td>
          <td>${d.modalitas}</td>
          <td>${d.tanggal}</td>
          <td>${d.status}</td>
          <td>${can ? `<button class="btn btn-success btn-sm" onclick="updateStatus('${c.key}')">Selesai</button>` : "-"}</td>
        </tr>`;
    });

    cBelum.innerText = b;
    cSudah.innerText = s;
    avgTime.innerText = cnt ? Math.round(total / cnt) + " menit" : "0 menit";
  });
}
</script>

</body>
</html>
