<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Radiologi | Permohonan Re-Expertise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Firebase -->
  <script>
    // Firebase SDK via CDN (non-module)
    const firebaseConfig = {
      databaseURL: "https://new-reexpertise2026-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ================= LOGIN ================= */
    window.currentRole = '';
    window.enterApp = function () {
      const role = document.getElementById('role').value;
      if (!role) return alert('Pilih role');
      window.currentRole = role;
      document.getElementById('login').classList.add('d-none');
      document.getElementById('app').classList.remove('d-none');
      document.getElementById('roleLabel').innerText = role;
    }

    /* ================= SUBMIT FORM ================= */
    window.submitForm = function () {
      const data = {
        norm: norm.value,
        pasien: pasien.value,
        tanggal: tanggal.value,
        modalitas: modalitas.value,
        jenis: jenis.value,
        alasan: alasan.value,
        status: 'Belum',
        jamMasuk: new Date().toISOString(),
        jamSelesai: ''
      };
      if (!data.norm || !data.pasien) return alert('Lengkapi data');
      push(ref(db, 'permohonan'), data);
      document.getElementById('formRe').reset();
    }

    /* ================= REALTIME DASHBOARD ================= */
    const table = document.getElementById('tbody');
    const countBelum = document.getElementById('cBelum');
    const countProses = document.getElementById('cProses');
    const countSudah = document.getElementById('cSudah');

    onValue(ref(db, 'permohonan'), snap => {
      table.innerHTML = '';
      let b = 0, p = 0, s = 0;
      let totalDurasi = 0;
      let selesaiCount = 0;

      snap.forEach(child => {
        const d = child.val();
        if (d.status === 'Belum') b++;
        if (d.status === 'Proses') p++;
        if (d.status === 'Sudah') {
          s++;
          if (d.jamMasuk && d.jamSelesai) {
            const masuk = new Date(d.jamMasuk);
            const selesai = new Date(d.jamSelesai);
            totalDurasi += (selesai - masuk) / 60000;
            selesaiCount++;
          }
        }

        const canUpdate = window.currentRole === 'Dokter Spesialis Radiologi' && d.status !== 'Sudah';

        table.innerHTML += `
          <tr>
            <td>${d.norm}</td>
            <td>${d.pasien}</td>
            <td>${d.modalitas}</td>
            <td>${d.tanggal}</td>
            <td>
              <span class="badge bg-${d.status==='Belum'?'warning':d.status==='Proses'?'primary':'success'}">${d.status}</span>
            </td>
            <td>
              ${canUpdate ? `<button class='btn btn-sm btn-outline-primary' onclick="updateStatus('${child.key}')">Selesai</button>` : '-'}
            </td>
          </tr>`;
      });

      countBelum.innerText = b;
      countProses.innerText = p;
      countSudah.innerText = s;

      document.getElementById('avgTime').innerText = selesaiCount > 0
        ? Math.round(totalDurasi / selesaiCount) + ' menit'
        : '0 menit';
    });
    });

    window.updateStatus = function (key) {
      if (window.currentRole !== 'Dokter Spesialis Radiologi') {
        alert('Hanya Radiolog yang dapat mengubah status');
        return;
      }
      const r = ref(db, 'permohonan/' + key);
      update(r, {
        status: 'Sudah',
        jamSelesai: new Date().toISOString()
      });
      window.open('https://wa.me/6285156868857?text=Hasil%20re-expertise%20radiologi%20telah%20selesai', '_blank');
    });
    }

  </script>
  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body class="bg-light">

<!-- LOGIN -->
<div id="login" class="container mt-5">
  <div class="card shadow">
    <div class="card-body">
      <h4 class="text-center mb-3">Login Role</h4>
      <select id="role" class="form-select mb-3">
        <option value="">-- Pilih Role --</option>
        <option>Dokter Spesialis Radiologi</option>
        <option>Ranap (DPJP / Pengirim / Karu / TAF)</option>
      </select>
      <button onclick="enterApp()" class="btn btn-primary w-100">Masuk</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="container d-none mt-4">
  <h5>Role: <span id="roleLabel"></span></h5>

  <!-- FORM -->
  <div class="card mb-4">
    <div class="card-header">Form Permohonan Re-Expertise</div>
    <div class="card-body">
      <form id="formRe">
        <div class="row g-2">
          <div class="col-md-3"><input id="norm" class="form-control" placeholder="No RM"></div>
          <div class="col-md-3"><input id="pasien" class="form-control" placeholder="Nama Pasien"></div>
          <div class="col-md-3"><input id="tanggal" type="date" class="form-control"></div>
          <div class="col-md-3">
            <select id="modalitas" class="form-select">
              <option>X-Ray</option><option>CT</option><option>MRI</option><option>USG</option>
            </select>
          </div>
          <div class="col-md-6"><input id="jenis" class="form-control" placeholder="Jenis Pemeriksaan"></div>
          <div class="col-md-6"><input id="alasan" class="form-control" placeholder="Alasan Re-Expertise"></div>
        </div>
        <button type="button" onclick="submitForm()" class="btn btn-success mt-3">Kirim Permohonan</button>
      </form>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="row mb-3">
    <div class="col"><div class="card text-center"><div class="card-body">‚è±Ô∏è Rata-rata<br><h3 id="avgTime">0 menit</h3></div></div></div>
    <div class="col"><div class="card text-center"><div class="card-body">üü° Belum<br><h3 id="cBelum">0</h3></div></div></div>
    <div class="col"><div class="card text-center"><div class="card-body">üîµ Proses<br><h3 id="cProses">0</h3></div></div></div>
    <div class="col"><div class="card text-center"><div class="card-body">üü¢ Sudah<br><h3 id="cSudah">0</h3></div></div></div>
  </div>

  <table class="table table-bordered table-sm bg-white">
    <thead class="table-light">
      <tr><th>No RM</th><th>Pasien</th><th>Modalitas</th><th>Tgl</th><th>Status</th><th>Aksi</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

</body>
</html>
